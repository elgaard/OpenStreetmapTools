<!DOCTYPE html>
  <html>
    <!--viser restauranter i fødevarekontrollens smiley ordning på OSM -->
    <!-- Der skal være en map.js fra leaflet i folderen -->
    <!-- Niels Elgaard Larsen -->
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF8">
<META name="keywords" content="restauranter smiley">
<meta http-equiv="Content-Type" content="text/html; charset=UTF8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="//code.jquery.com/jquery-latest.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
  <!-- script src="leaflet.label.js"></script -->
<script src="map.js"></script>
<title>Unify OSM og Fødevarestyrelses kontrolrapporter based on geo/name matching</title>
<script>L_PREFER_CANVAS = true;</script>
<script>
    var map;
    var data;
    var poiUrl = 'data/match.json';
    var markers = new L.FeatureGroup();

   $(function () {
      map = POImap.init();
      map.addLayer(markers);
      map.zoomIn();
      $.getJSON(poiUrl).then(function (d) {
        data=d;
        loadPoi();
      })
    });
      
    function do_batch() {
      var max=100;
      var done=0;
      var i=0;
      while (done<max && i<data.length) {
        r=data[i];
        if (!r.done && (!r["osm:navnelbnr"] && r["xxfvst:navnelbnr"]  || r["exact"]) ) {
          var jsurl='http://localhost:8111/load_object?objects='+r["type"].charAt(0)+r.id+'&addtags=fvst%3Anavnelbnr='+r["fvst:navnelbnr"]+'%257Cfvst%3Aname='+encodeURIComponent(r["fvst:name"]);
	  var js=$.get(jsurl);
          r.done=true;
          done++;
        }
        i++;
      }
      markers.clearLayers();
      loadPoi();
    };

    function loadPoi() {
      var poiInfo = function(pi) {
	var fvstname=pi["fvst:name"];
    	var osmname=pi["osm:name"];
        var osmlbnr=pi["osm:navnelbnr"];
	var id=pi["id"]
	var typeF=pi["type"].charAt(0);
	var fvstid=pi["fvst:navnelbnr"]
	var r = $('<table>');
        if (fvstname) {
	  r.append($('<tr>').append($('<th>').html('fvst name: '+fvstname)));
        }
	r.append($('<tr>').append($('<th>').html($('<a>',{ target:'osm', text: 'osm  name:' +osmname, href:'https://www.openstreetmap.org/'+pi['type']+'/'+pi['id']}))));
        
	var jsurl='http://localhost:8111/load_object?objects='+typeF+id+'&addtags=fvst%3Anavnelbnr='+fvstid;
        var mergejsurl='http://localhost:8111/load_object?objects='+typeF+id+'&addtags=fvst%3Anavnelbnr='+fvstid+"%257Cname="+encodeURIComponent($("<div />").text(fvstname).html()).replace("`","").replace("'","")+"%257Cphone=%257Cwebsite=%257Ccuisine=%257Coperator=%257Copening_hours=";
        if (pi['exact']) jsurl+='%257Cfvst%3Aname='+encodeURIComponent(pi["fvst:name"]);

	var js="javascript:void $.get('"+jsurl+"')";
	var mergejs="javascript:void $.get('"+mergejsurl+"')";
        if (pi["category"]=="fvst:no_pos") {
          jsurl+='%257Cfvst%3Afixme=fvst:no_pos';
	  var js="javascript:void $.get('"+jsurl+"')";
	  r.append($('<tr>').append($('<td>').html($('<a>',{text: 'update fvst:navnelbnr. First check address (No pos in FVST)',  href:js }))));
	  r.append($('<tr>').append($('<td>').html($('<a>',{ target:'fvst', text: 'FVST: fvst:navnelbnr: '+fvstid, href:'http://www.findsmiley.dk/'+fvstid}))));
        } else if (pi["notinfvst"]) {
          r.append($('<tr>').append($('<td>').html("food place has no fvst:navnelbnr tag: Delete, Add tag or Merge")));
          r.append($('<tr>').append($('<td>').html($('<a>',{ target:'searchforFVSTfood', text: 'DuckD search: ',href:'https://duckduckgo.com/?q='+osmname+'%20"'+'Denmark"'}))));
          r.append($('<tr>').append($('<td>').html($('<a>',{ target:'FVSTsearch', text: 'FVST search: ', href:'http://www.findsmiley.dk/Sider/Search.aspx?k='+osmname.replace('&','')+'%20'+''}))));
 	  var jsdelurl='http://localhost:8111/load_object?objects='+typeF+id;
	  var jsdel="javascript:void $.get('"+jsurl+"')";
	  r.append($('<tr>').append($('<td>').html($('<a>',{text: 'open in JOSM for manual deletion',  href:jsdel }))));
        } else {
	  r.append($('<tr>').append($('<td>').html($('<a>',{text: 'merge at blue/orange point in JOSM',  href:js }))));
	  r.append($('<tr>').append($('<td>').html($('<a>',{ target:'fvst', text: 'FVST: fvst:navnelbnr: '+fvstid, href:'http://www.findsmiley.dk/'+fvstid}))));
        }
        
        if (osmlbnr) {
	  r.append($('<tr>').append($('<td>').html($('<a>',{ target:'osmfvst', text: 'OSM: fvst:navnelbnr: '+osmlbnr, href:'http://www.findsmiley.dk/'+osmlbnr}))));			      
        } else if (! pi["notinfvst"]){
	  r.append($('<tr>').append($('<td>').html($('<a>',{text: 'overwrite osm node in JOSM',  href:mergejs }))));
        }
        return $('<div>').append(r).html();
      };
      $.each(data, function(ign, i) {
          if (!i.done) {
	    var osmll=new L.LatLng(i.lat, i.lon);
	    var fvstll;
            if (i.slat && i.slon) {
                fvstll=new L.LatLng(i.slat, i.slon);
            }
    	    var pl;
    	    var mk;

            if (i["exact"]) {
	      mk=L.circle(osmll,13,{color: 'green'}).addTo(markers);
	      pl = L.polyline([osmll,fvstll], {color: 'green'}).addTo(markers);	      
	    } else if (i["notinfvst"]) {
	      mk=L.circle(osmll,11,{color: 'cyan',weight:10,fill:true}).addTo(markers);
	    } else if (i["category"]=="fvst:no_pos") {
	      mk=L.circle(osmll,11,{color: 'brown',weight:10,fill:true}).addTo(markers);
	    } else if (i["osm:navnelbnr"]) {
	      mk=L.circle(osmll,3,{color: 'blue'}).addTo(markers);
	      pl = L.polyline([osmll,fvstll], {color: 'blue'}).addTo(markers);
	    } else if (i["exact"]) {
	      mk=L.circle(osmll,9,{color: 'green'}).addTo(markers);
	      pl = L.polyline([osmll,fvstll], {color: 'green'}).addTo(markers);	      
	    } else if (!i["fvst:navnelbnr"]) {
	      mk=L.circle(osmll,5,{color: 'red'}).addTo(markers);
	      pl = L.polyline([osmll,fvstll], {color: 'red'}).addTo(markers);	      
	    } else {
	      mk=L.circle(osmll,14,{color: 'orange',fill:true}).addTo(markers);
	      pl = L.polyline([osmll,fvstll], {color: 'orange'}).addTo(markers);	      
	    }
            mk.bindPopup(poiInfo(i)).addTo(markers);
	  }
        });
    }
  </script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html, body, #map {
      height: 99%;
    }
  </style>
  </head>
    <body bgcolor="#ffffff" text="#000000" link="#000099" vlink="#660000">
  <!--button OnClick="do_batch()" >batch</button-->

  <a href="index.html">Menu</a>  fvst:navnelbnr import tool based on name and location matching (Niels Elgaard Larsen, elgaard@agol.dk), start new layer in JOSM, orange=no valid navnelbnr in OSM, green=exact same pos, blue=fuzzy match
  <div id="map"></div>  
  </body>
  </html>
  
